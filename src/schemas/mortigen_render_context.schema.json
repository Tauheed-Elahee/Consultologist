{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://consultologist.ai/schemas/mortigen_render_context.schema.json",
  "title": "Mortigen Render Context",
  "type": "object",
  "additionalProperties": false,
  "required": ["front_matter"],
  "properties": {
    "front_matter": {
      "type": "object",
      "additionalProperties": false,
      "required": ["patient", "staging", "pathology", "receptors", "plan_structured"],
      "properties": {
        "patient": {
          "type": "object",
          "additionalProperties": false,
          "required": ["name", "age_years", "sex", "pronoun"],
          "properties": {
            "name": { "type": "string" },
            "full_name": { "type": "string" },
            "dob": { "type": "string" },
            "age_years": { "type": "integer", "minimum": 0, "maximum": 130 },
            "sex": { "type": "string", "enum": ["female", "male", "other", "unknown"] },
            "pronoun": {
              "type": "object",
              "additionalProperties": false,
              "required": ["nom", "gen", "obj", "refl"],
              "properties": {
                "nom":  { "type": "string" },  // e.g., "she" | "he" | "they"
                "gen":  { "type": "string" },  // e.g., "her" | "his" | "their"
                "obj":  { "type": "string" },  // e.g., "her" | "him" | "them"
                "refl": { "type": "string" }   // e.g., "herself" | "himself" | "themself"
              }
            }
          }
        },
        "encounter": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "datetime": { "type": "string" }  // ISO-8601 preferred; renderer just prints
          }
        },
        "diagnosis": {
          "type": "array",
          "items": { "type": "string" }
        },
        "staging": {
          "type": "object",
          "additionalProperties": false,
          "required": ["stage_group", "tnm"],
          "properties": {
            "stage_group": { "type": "string", "pattern": "^Stage\\s*(0|I{1,3}(A|B|C)?|IV)$" },
            "tnm": {
              "type": "object",
              "additionalProperties": false,
              "required": ["prefix", "T", "N", "M"],
              "properties": {
                "prefix": { "type": "string", "enum": ["p", "c", "yp", "yc", "x"] },
                "T":      { "type": "string", "pattern": "^T(is|1a|1b|1c|1|2|3|4[abcd]?)$" },
                "N":      { "type": "string", "pattern": "^N(0|1[abc]?|2[ab]?|3[abc]?)$" },
                "M":      { "type": "string", "pattern": "^M(0|1|X)$" }
              }
            }
          }
        },
        "pathology": {
          "type": "object",
          "additionalProperties": false,
          "required": ["histology", "grade", "tumor_size_cm", "nodes_examined", "nodes_positive"],
          "properties": {
            "histology":      { "type": "string" },
            "grade":          { "type": "string", "pattern": "^[123]$" },
            "tumor_size_cm":  { "type": "number", "minimum": 0, "maximum": 20 },
            "dcis_present":   { "type": "boolean" },
            "margins":        { "type": "string" },
            "nodes_examined": { "type": "integer", "minimum": 0 },
            "nodes_positive": { "type": "integer", "minimum": 0 }
          }
        },
        "receptors": {
          "type": "object",
          "additionalProperties": false,
          "required": ["ER", "PR", "her2"],
          "properties": {
            "ER": { "type": "string", "pattern": "^[0-8]/8$" },
            "PR": { "type": "string", "pattern": "^[0-8]/8$" },
            "her2": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "raw_text":   { "type": "string" },  // verbatim source text for audit
                "label":      { "type": "string", "enum": ["HER2-positive", "HER2-negative", "HER2 status equivocal/unknown"] },
                "detail":     { "type": "string" },
                "ihc_score":  { "type": ["string", "null"], "enum": ["0", "1+", "2+", "3+", null] },
                "fish_result":{ "type": ["string", "null"], "enum": ["positive", "negative", "equivocal", "not_done", null] }
              },
              "allOf": [
                { "if": { "required": ["label"] }, "then": { "required": ["raw_text"] } }
              ]
            }
          }
        },
        "oncotype": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "score": { "type": "number", "minimum": 0, "maximum": 100 },
            "risk_percent_9yr": { "type": "number", "minimum": 0, "maximum": 100 },
            "absolute_benefit_percent": { "type": "number", "minimum": 0, "maximum": 100 }
          },
          "allOf": [
            { "if": { "required": ["score"] }, "then": { "required": ["risk_percent_9yr"] } }
          ]
        },
        "plan_structured": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "endocrine": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "ordered": { "type": "boolean" },
                "agent":   { "type": "string", "enum": ["letrozole", "tamoxifen", "other"] },
                "agent_other": { "type": ["string", "null"] }
              }
            },
            "radiation_referred": { "type": "boolean" },
            "chemotherapy": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "recommended": { "type": "boolean" },
                "risk_basis":  { "type": "string", "enum": ["low_oncotype", "high_oncotype", "high_risk_features", "her2_positive", "other"] },
                "regimen":     { "type": ["string", "null"], "enum": ["BRAJACTG", "BRAJDC", "AC_TH", "TCH", null] },
                "regimen_other": { "type": ["string", "null"] }
              }
            }
          }
        },
        "medications": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "label": { "type": "string" },
              "dose": { "type": ["string", "number"] },
              "dose_unit": { "type": "string" },
              "route": { "type": "string" },
              "frequency": { "type": "string" },
              "prn": { "type": "boolean" },
              "indication": { "type": ["string", "null"] }
            }
          }
        },
        "allergies": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "agent": { "type": "string" },
              "reaction": { "type": "string" },
              "severity": { "type": "string" }
            }
          }
        }
      }
    },
    "content": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "reason": { "type": ["string", "null"] },
        "hpi": { "type": ["string", "null"] },
        "pmh": { "type": ["string", "null"] },
        "meds": { "type": ["string", "null"] },
        "allergies": { "type": ["string", "null"] },
        "social": { "type": ["string", "null"] },
        "family": { "type": ["string", "null"] },
        "exam": { "type": ["string", "null"] },
        "investigations": { "type": ["string", "null"] }
      }
    },
    "extras": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "side": { "type": "string", "enum": ["left", "right"] }
      }
    },
    "flags": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "exam_present": { "type": "boolean" }
      }
    }
  }
}